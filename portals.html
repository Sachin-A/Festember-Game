<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8" />
		<title>Portal</title>
		<script type="text/javascript" src="Box2D.js"></script>
		<style>
			html,
			body {
				font-size:18px;
				width: 100%;
				height: 100%;
				margin: 0px;
				border: 0;
				overflow: hidden;
				display: block;
			}
		</style>
	</head>

	<body onresize="resize_canvas()" onkeydown="downkeyhandler(event)" onkeyup="upkeyhandler(event)">
		<!-- An fps counter -->
		<div id="fps"></div>
		<canvas id="canvas" style="background-color:rgba(0, 0, 0, 0.5)"></canvas>
	</body>
	<script>
	
		//canvas variables
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');
		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
		
		//GLOBAL: canvas resize function & variables
		function resize_canvas()
		{
			canvas = document.getElementById("canvas");
			if (canvas.width < window.innerWidth)
			{
				canvas.width = window.innerWidth;
			}
			if (canvas.height < window.innerHeight)
			{
				canvas.height = window.innerHeight;
			}
		}
		var ylimit = canvas.height;
		var xlimit = canvas.width;
		var xylimit = ylimit * xlimit;
		var scale = 30;
		
		//function initialisations
		var b2Vec2 = Box2D.Common.Math.b2Vec2,
			b2BodyDef = Box2D.Dynamics.b2BodyDef,
			b2Body = Box2D.Dynamics.b2Body,
			b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
			b2World = Box2D.Dynamics.b2World,
			b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
			b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
			b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef,
			b2MouseJointDef = Box2D.Dynamics.Joints.b2MouseJointDef,
			b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
			b2Fixture = Box2D.Dynamics.b2Fixture,
			b2RayCastInput = Box2D.Collision.b2RayCastInput,
			b2RayCastOutput = Box2D.Collision.b2RayCastOutput,
			b2AABB = Box2D.Collision.b2AABB;
			
		//world variable
		var world = new b2World(new b2Vec2(0, 10), true);
		
		//ray variables
		var rayLength = xlimit; //long enough to hit the walls
		var currentRayAngle = 0;
		var input = new b2RayCastInput();
		var output = new b2RayCastOutput();
		var b = new b2BodyDef();
		var f = new b2FixtureDef();
		var closestFraction = 1;
		var intersectionNormal = new b2Vec2(0, 0);
		var intersectionPoint = new b2Vec2();
		var p2 = new b2Vec2();
		var normalEnd = new b2Vec2();
		var scope = 0;
		var DEGTORAD = Math.PI / 180;
		var count=0;
		var circle=0;
		
		//portal variable
		var current = 0;
		
		//conveyor and attach variables
		var attached = 0;
		var toattach = 0;
		var levattach = 0;
		var levattached = 0;
		var move1 = new b2Vec2(7*xlimit/1200, 0);
		var move2 = new b2Vec2(0, -8 * ylimit / 900);
		var move3 = new b2Vec2(-10 * xlimit / 1200, 0);
		var zero = new b2Vec2(0, 0);
		
		//Player: Circle
		//body definition
		var bodyDef = new b2BodyDef;
		bodyDef.type = b2Body.b2_dynamicBody;
		bodyDef.position.Set(4 * xlimit / 1200, 25 * ylimit / 900);
		bodyDef.userData = 'obj';
		
		//fixture definition
		var fixDef = new b2FixtureDef;
		fixDef.density = 10;
		fixDef.friction = 0.5;
		fixDef.restitution = 0.6;
		fixDef.shape = new b2CircleShape(1 * (xlimit + ylimit) / (1200 + 900));
		
		//wheel creation
		var wheel = world.CreateBody(bodyDef);
		wheel.CreateFixture(fixDef);
		
		//Assigning wheel's position as the beginning point of ray casting
		var p1 = wheel.GetPosition(); //centre of scene
		
		//anti-gravity variable
		var attract = new b2Vec2(0, -10*wheel.GetMass());
		
		//force variable
		var f1 = new b2Vec2(6*wheel.GetMass(),0);
		var f2 = new b2Vec2(0,-12*wheel.GetMass());
		var f3 = new b2Vec2(-12*wheel.GetMass(),0);
		
		//fps display
		var fps = 
		{
			startTime : 0,
			frameNumber : 0,
			getFPS :function()
					{
						this.frameNumber++;
						var d = new Date().getTime(),
						currentTime = ( d - this.startTime ) / 1000,
						result = Math.floor( ( this.frameNumber / currentTime ) );

						if( currentTime > 1 )
						{
							this.startTime = new Date().getTime();
							this.frameNumber = 0;
						}
						return result;
					}   
		};
		var fpsa=document.getElementById('fps');
		
		//GLOBAL: portals function to exchange position
		function portals()
		{
			if (Math.sqrt(Math.pow(wheel.GetPosition().x*scale - portalsystem.blueportal.x, 2) + Math.pow(wheel.GetPosition().y*scale - portalsystem.blueportal.y, 2)) <= scale*xlimit / 1200 && current == 0)
			{
				var xpor = portalsystem.redportal.x/scale;
				var ypor = portalsystem.redportal.y/scale;
				var por=new b2Vec2(xpor,ypor);
				wheel.SetPosition(por);
				current = 1;
			}
			else if (Math.sqrt(Math.pow(wheel.GetPosition().x*scale - portalsystem.redportal.x, 2) + Math.pow(wheel.GetPosition().y*scale - portalsystem.redportal.y, 2)) <= scale*xlimit / 1200 && current == 0)
			{
				var xpor = portalsystem.blueportal.x/scale;
				var ypor = portalsystem.blueportal.y/scale;
				var por=new b2Vec2(xpor,ypor);
				wheel.SetPosition(por);	
				current = 1;
			}
			else if (wheel.GetPosition().x*scale != portalsystem.blueportal.x && wheel.GetPosition().y*scale!= portalsystem.blueportal.y && wheel.GetPosition().x*scale != portalsystem.redportal.x && wheel.GetPosition().y*scale!= portalsystem.redportal.y) 
				current = 0;
		}
		
		var portalsystem = 
		{
			radius: 25,
			blueportal:{},
			redportal:{},
			draw: function ()
			{
				ctx.fillStyle = this.redportal.color;
				ctx.beginPath();
				ctx.arc(this.redportal.x, this.redportal.y, this.radius, 0, Math.PI * 2, false);
				ctx.closePath();
				ctx.fill();
				ctx.fillStyle = this.blueportal.color;
				ctx.beginPath();
				ctx.arc(this.blueportal.x, this.blueportal.y, this.radius, 0, Math.PI * 2, false);
				ctx.closePath();
				ctx.fill();
			}
		};
		function ray()
		{
			var k = 360 / 5;
			var t = k / 60;
			currentRayAngle += t * DEGTORAD;
			p2.x = p1.x + rayLength * Math.sin(currentRayAngle);
			p2.y = p1.y + rayLength * Math.cos(currentRayAngle);
			input.p1 = p1;
			input.p2 = p2;
			input.maxFraction = 1;
			closestFraction = 1;
			//var tempbody= new b2BodyDef(); 
			var b = new b2BodyDef();
			var f = new b2FixtureDef();
			for (b = world.GetBodyList(); b; b = b.GetNext())
			{
				for (f = b.GetFixtureList(); f; f = f.GetNext())
				{
					if (!f.RayCast(output, input))
						continue;
					else if (output.fraction < closestFraction)
					{
						//tempbody=b;
						closestFraction = output.fraction;
						intersectionNormal = output.normal;
					}
				}
			}
			intersectionPoint.x = p1.x + closestFraction * (p2.x - p1.x);
			intersectionPoint.y = p1.y + closestFraction * (p2.y - p1.y);
			normalEnd.x = intersectionPoint.x + intersectionNormal.x;
			normalEnd.y = intersectionPoint.y + intersectionNormal.y;
			ctx.strokeStyle = "rgba(255, 255, 255, 1)";
			ctx.lineWidth = 25;
			ctx.bordercolor = 'red';
			ctx.borderwidth = 10;
			ctx.beginPath();
			ctx.moveTo(p1.x * 30, p1.y * 30);
			ctx.lineTo(intersectionPoint.x * 30, intersectionPoint.y * 30);
			ctx.closePath();
			ctx.stroke();
			ctx.lineWidth = 1;
			/*if(count!=0)
			{
				if (portalsystem.redportal.exist == 0)
				{
					portalsystem.redportal.x = intersectionPoint.x *scale;
					portalsystem.redportal.y = intersectionPoint.y *scale;
				}
				if (portalsystem.blueportal.exist == 0)
				{
					portalsystem.blueportal.x = wheel.GetPosition().x*scale;
					portalsystem.blueportal.y = wheel.GetPosition().y*scale;
				}
			}*/
		}
		function downkeyhandler(event)
		{
			var keycode = event.which;
			//console.log("We're in down");
			switch (keycode)
			{
			case 32: //console.log("We're in key");
				toattach = 1;
				levattach = 1;
				break;
			case 37:
				var mass = wheel.GetMass() * 10;
				wheel.ApplyImpulse(new b2Vec2(-mass, 0), wheel.GetPosition());
				break;
			case 38:
				var mass = wheel.GetMass() * 10;
				wheel.ApplyImpulse(new b2Vec2(0, -mass), wheel.GetPosition());
				break;
			case 39:
				var mass = wheel.GetMass() * 10;
				wheel.ApplyImpulse(new b2Vec2(mass, 0), wheel.GetPosition());
				break;
			case 40:
				var mass = wheel.GetMass() * 10;
				wheel.ApplyImpulse(new b2Vec2(0, mass), wheel.GetPosition());
				break;
			case 79:circle=1;
					break;
			case 80:
				scope = 1;
				break;
			case 66:
				if (portalsystem.blueportal.exist == 0 && scope==1)
				{
					portalsystem.blueportal.exist = 1;
					portalsystem.draw();
				}
				break;
			case 82:
				if (portalsystem.redportal.exist == 0 && scope==1)
				{
					portalsystem.redportal.exist = 1;
					portalsystem.draw();
				}
				break;
			case 88:DEGTORAD=-Math.PI / 180;
					break;
			case 90:DEGTORAD=Math.PI / 180;
					break;
			default:
				break;
			}
		}
		function upkeyhandler(event)
		{
			var keycode = event.which;
			switch (keycode)
			{
			
			case 32:if(attached==1||attached==2||attached==3)wheel.ApplyImpulse(f1,wheel.GetPosition());
					else if(attached==4||attached==5||attached==6)wheel.ApplyImpulse(f2,wheel.GetPosition());
					else if(attached==7||attached==8||attached==9)wheel.ApplyImpulse(f3,wheel.GetPosition());
					toattach = 0;
					attached = 0;
					levattach = 0;
					levattached = 0;
					if(count==0)count=1;
					break;
			case 79:circle = 0;
			        break;
			case 80:scope = 0;
					break;
			
			default:
				break;
			}
		}
		var debugDraw = new b2DebugDraw();
		debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
		debugDraw.SetDrawScale(30); //define scale
		debugDraw.SetFillAlpha(1); //define transparency
		debugDraw.SetLineThickness(0.1);
		debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
		//debugDraw.SetFlags(b2DebugDraw.e_shapeBit);
		world.SetDebugDraw(debugDraw);
		var winx = 7*scale*xlimit/1200;
		var winy = ylimit - (19 *scale* ylimit / 900);
		function level1()
		{
			console.log("Inside level1");
			// Ground 1
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
			var fd = new b2FixtureDef;
			fd.shape = new b2PolygonShape;
			fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
			var fd1 = new b2FixtureDef;
			fd1.shape = new b2PolygonShape;
			fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, -1.1*ylimit/900), 0);
			fd1.isSensor=true;
			var ground1 = world.CreateBody(bodyDef);
			ground1.CreateFixture(fd);
			ground1.CreateFixture(fd1);
			
			// Ground 2
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set((xlimit / scale) - (9 * xlimit / 1200), (ylimit / scale) - (1 * ylimit / 900));
			var fd = new b2FixtureDef;
			fd.shape = new b2PolygonShape;
			fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
			var fd1 = new b2FixtureDef;
			fd1.shape = new b2PolygonShape;
			fd1.isSensor=true;
			fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, -1.1*ylimit/900), 0);
			var ground2 = world.CreateBody(bodyDef);
			ground2.CreateFixture(fd);
			ground2.CreateFixture(fd1);
			
			// First floor
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(18 * xlimit / 1200, (ylimit / scale) - (12 * ylimit / 900));
			var floor = new b2FixtureDef;
			floor.shape = new b2PolygonShape();
			floor.shape.SetAsOrientedBox(18 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var firstfloor = world.CreateBody(bodyDef);
			firstfloor.CreateFixture(floor);
			
			//c1b1
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(3 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
			var box1 = new b2FixtureDef;
			box1.shape = new b2PolygonShape();
			box1.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var fd1 = new b2FixtureDef;
			fd1.shape = new b2PolygonShape;
			fd1.shape.SetAsOrientedBox(1.5 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 1.1*ylimit/900), 0);
			fd1.isSensor=true;
			var c1b1 = world.CreateBody(bodyDef);
			c1b1.CreateFixture(box1);
			c1b1.CreateFixture(fd1);
			
			//c1b2
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(15 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
			var box2 = new b2FixtureDef;
			box2.shape = new b2PolygonShape();
			box2.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var fd1 = new b2FixtureDef;
			fd1.shape = new b2PolygonShape;
			fd1.shape.SetAsOrientedBox(1.5 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 1.1*ylimit/900), 0);
			fd1.isSensor=true;
			var c1b2 = world.CreateBody(bodyDef);
			c1b2.CreateFixture(box2);
			c1b2.CreateFixture(fd1);
			
			//c1b3
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(27 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
			var box3 = new b2FixtureDef;
			box3.shape = new b2PolygonShape();
			box3.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var fd1 = new b2FixtureDef;
			fd1.shape = new b2PolygonShape;
			fd1.shape.SetAsOrientedBox(1.5 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 1.1*ylimit/900), 0);
			fd1.isSensor=true;
			var c1b3 = world.CreateBody(bodyDef);
			c1b3.CreateFixture(box3);
			c1b3.CreateFixture(fd1);
			
			//lift
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set((xlimit / scale) - (0.5 * xlimit / 1200), (ylimit / scale) - (12 * ylimit / 900));
			var f = new b2FixtureDef;
			f.shape = new b2PolygonShape();
			f.shape.SetAsOrientedBox(0.5 * xlimit / 1200, 12 * ylimit / 900, new b2Vec2(0, 0), 0);
			var lift = world.CreateBody(bodyDef);
			lift.CreateFixture(f);
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (2 * ylimit / 900));
			var b1 = new b2FixtureDef;
			b1.shape = new b2PolygonShape();
			b1.shape.SetAsOrientedBox(0.5 * xlimit / 1200, 2 * ylimit / 900, new b2Vec2(0, 0), 0);
			var c2b1 = world.CreateBody(bodyDef);
			c2b1.CreateFixture(b1);
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (10 * ylimit / 900));
			var b2 = new b2FixtureDef;
			b2.shape = new b2PolygonShape();
			b2.shape.SetAsOrientedBox(0.5 * xlimit / 1200, 2 * ylimit / 900, new b2Vec2(0, 0), 0);
			var c2b2 = world.CreateBody(bodyDef);
			c2b2.CreateFixture(b2);
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (18 * ylimit / 900));
			var b3 = new b2FixtureDef;
			b3.shape = new b2PolygonShape();
			b3.shape.SetAsOrientedBox(0.5 * xlimit / 1200, 2 * ylimit / 900, new b2Vec2(0, 0), 0);
			var c2b3 = world.CreateBody(bodyDef);
			c2b3.CreateFixture(b3);
			
			// intermediate floor
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(18 * xlimit / 1200, (ylimit / scale) - (16 * ylimit / 900));
			var floor = new b2FixtureDef;
			floor.shape = new b2PolygonShape();
			floor.shape.SetAsOrientedBox(18 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var Ifloor = world.CreateBody(bodyDef);
			Ifloor.CreateFixture(floor);
			
			// Second floor
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(22 * xlimit / 1200, (ylimit / scale) - (29 * ylimit / 900));
			var floor2 = new b2FixtureDef;
			floor2.shape = new b2PolygonShape();
			floor2.shape.SetAsOrientedBox(18 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var floor2 = world.CreateBody(bodyDef);
			floor2.CreateFixture(floor);
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(13 * xlimit / 1200, (ylimit / scale) - (27 * ylimit / 900));
			var bx1 = new b2FixtureDef;
			bx1.shape = new b2PolygonShape();
			bx1.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var c3b1 = world.CreateBody(bodyDef);
			c3b1.CreateFixture(bx1);
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(25 * xlimit / 1200, (ylimit / scale) - (27 * ylimit / 900));
			var bx2 = new b2FixtureDef;
			bx2.shape = new b2PolygonShape();
			bx2.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var c3b2 = world.CreateBody(bodyDef);
			c3b2.CreateFixture(bx2);
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(37 * xlimit / 1200, (ylimit / scale) - (27 * ylimit / 900));
			var bx3 = new b2FixtureDef;
			bx3.shape = new b2PolygonShape();
			bx3.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
			var c3b3 = world.CreateBody(bodyDef);
			c3b3.CreateFixture(bx3);
			function conveyor_motion()
			{
				var b = new b2BodyDef();
				for (b = world.GetBodyList(); b; b = b.GetNext())
				{
					if (b == c1b1 || b == c1b2 || b == c1b3)
					{
						//console.log(b.GetPosition());
						var back1 = new b2Vec2(-3 * xlimit / 1200, b.GetPosition().y);
						if (b.GetPosition().x >= 33 * xlimit / 1200)
							b.SetPosition(back1);
						var movex = b.GetPosition().x + (0.1 * xlimit / 1200);
						var movey = b.GetPosition().y;
						var move = new b2Vec2(movex, movey);
						b.SetPosition(move);
						//wheel.SetLinearVelocity(move);
					}
					if (b == c2b1 || b == c2b2 || b == c2b3)
					{
						//console.log(b.GetPosition());
						var back2 = new b2Vec2(b.GetPosition().x, 32 * ylimit / 900);
						if (b.GetPosition().y <= 8 * ylimit / 900)
							b.SetPosition(back2);
						var movex = b.GetPosition().x;
						var movey = b.GetPosition().y - (0.2 * ylimit / 900);
						var move = new b2Vec2(movex, movey);
						b.SetPosition(move);
						//wheel.SetLinearVelocity(move);
					}
					if (b == c3b1 || b == c3b2 || b == c3b3)
					{
						//console.log(b.GetPosition());
						var back3 = new b2Vec2(43 * xlimit / 1200, b.GetPosition().y);
						if (b.GetPosition().x <= 7 * xlimit / 1200)
							b.SetPosition(back3);
						var movex = b.GetPosition().x - (0.2 * xlimit / 1200);
						var movey = b.GetPosition().y;
						var move = new b2Vec2(movex, movey);
						b.SetPosition(move);
						//wheel.SetLinearVelocity(move);
					}
				}
			}
			function attach()
			{
				for (b = world.GetBodyList(); b; b = b.GetNext())
				{
					if (b == c1b1)
						if (attached ==1 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 5 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x, b.GetPosition().y+2*ylimit/900);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 1;
;							}
						}
					if (b == c1b2)
						if (attached ==2 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 5 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x, b.GetPosition().y+2*ylimit/900);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 2;
							}
						}
				
					if (b == c1b3)
						if (attached ==3 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 5 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x, b.GetPosition().y+2*ylimit/900);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 3;
							}
						}
					if (b == c2b1)
						if (attached ==4 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 4 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x-1.4*xlimit/1200, b.GetPosition().y);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 4;
							}
						}
					if (b == c2b2)
						if (attached ==5 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 4 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x-1.4*xlimit/1200, b.GetPosition().y);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 5;
							}
						}
					if (b == c2b3)
						if (attached ==6 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 4 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x-1.4*xlimit/1200, b.GetPosition().y);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 6;
							}
						}
					if (b == c3b1)
						if (attached ==7 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 7 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x, b.GetPosition().y + 2*ylimit/900);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 7;
							}
						}
					if (b == c3b2)
						if (attached ==8 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 7 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x, b.GetPosition().y + 2*ylimit/900);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 8;
							}
						}
					if (b == c3b3)
						if (attached ==9 || attached==0)
						{
							if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 7 * xlimit / 1200)
							{
								var set = new b2Vec2(b.GetPosition().x, b.GetPosition().y + 2*ylimit/900);
								wheel.SetPosition(set);
								wheel.ApplyForce(attract,wheel.GetPosition());
								wheel.SetLinearVelocity(zero,wheel.GetPosition());
								attached = 9;
							}
						}
				}
			}
			update1();
			function update1()
			{
				if (toattach == 1)
				{
					attach();
				}
				world.Step(1 / 60, 10, 10);
				world.DrawDebugData();
				world.ClearForces();
				fpsa.innerHTML=fps.getFPS();
				conveyor_motion();
				if(circle==1)
				{
					ctx.fillStyle = "rgba(255,255,255,0.1)";
					ctx.beginPath();
					ctx.arc(wheel.GetPosition().x*scale,wheel.GetPosition().y*scale,15*scale, 0, Math.PI * 2, false);
					ctx.closePath();
					ctx.fill();
				}
				portals();
				if (portalsystem.redportal.exist == 1 || portalsystem.blueportal.exist == 1)
					portalsystem.draw();
				if (portalsystem.redportal.exist == 1 && portalsystem.blueportal.exist == 1)
					portalsystem.draw();
				if (scope == 1)
				{
					ray();
				}
				ctx.fillStyle = 'cyan';
				ctx.beginPath();
				ctx.arc(winx, winy, 15*(xlimit+ylimit)/(1200+900), 0, Math.PI * 2, false);
				ctx.closePath();
				ctx.fill();
				if (Math.sqrt(Math.pow(wheel.GetPosition().x * scale - winx, 2) + Math.pow(wheel.GetPosition().y * scale - winy, 2)) > 50)
				{
					var frame = window.requestAnimationFrame(update1);
				}
				else
				{
					console.log("Done");
					level2();
				}
			}
		}
		function level2()
		{
			for (b = world.GetBodyList(); b; b = b.GetNext())
			{
				if (b != wheel)
					world.DestroyBody(b);
			}
			console.log("Second level");
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
			var fd = new b2FixtureDef;
			fd.shape = new b2PolygonShape;
			fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
			var ground1 = world.CreateBody(bodyDef);
			ground1.CreateFixture(fd);
			// Tile 1
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(25 * xlimit / 1200, (ylimit / scale) - (15 * ylimit / 900));
			var fd = new b2FixtureDef;
			fd.shape = new b2PolygonShape;
			fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 2);
			var tile1 = world.CreateBody(bodyDef);
			tile1.CreateFixture(fd);
			// Tile 2
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(13 * xlimit / 1200, (ylimit / scale) - (5 * ylimit / 900));
			var fd = new b2FixtureDef;
			fd.shape = new b2PolygonShape;
			fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 2);
			var tile2 = world.CreateBody(bodyDef);
			tile2.CreateFixture(fd);
			// Tile 3
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(19 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
			var fd = new b2FixtureDef;
			fd.shape = new b2PolygonShape;
			fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 2);
			var tile3 = world.CreateBody(bodyDef);
			tile3.CreateFixture(fd);
			// Tile 4
			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_staticBody;
			bodyDef.position.Set(31 * xlimit / 1200, (ylimit / scale) - (20 * ylimit / 900));
			var fd = new b2FixtureDef;
			fd.shape = new b2PolygonShape;
			fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 2);
			var tile4 = world.CreateBody(bodyDef);
			tile4.CreateFixture(fd);
			xincrease = 1;
			function movetile()
			{
				xincrease = xincrease + 1;
				for (b = world.GetBodyList(); b; b = b.GetNext())
					if (b == tile1 || b == tile2 || b == tile3 || b == tile4)
						b.SetAngle(xincrease * (Math.PI / 180));
			}
			var debugDraw = new b2DebugDraw();
			debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
			debugDraw.SetDrawScale(30); //define scale
			debugDraw.SetFillAlpha(1); //define transparency
			debugDraw.SetLineThickness(1);
			debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
			//debugDraw.SetFlags(b2DebugDraw.e_shapeBit);
			world.SetDebugDraw(debugDraw);
			function attach2()
			{
				for (b = world.GetBodyList(); b; b = b.GetNext())
					if (b == tile1 || b == tile2 || b == tile3 || b == tile4)
					{
						if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 7 * xlimit / 1200 && levattached == 0)
						{
							var set = new b2Vec2(b.GetPosition().x, b.GetPosition().y - 2);
							//console.log("Attached in A=" + attached);
							wheel.SetPosition(set);
							levattached = 1;
						}
					}
			}
			update2();
			function update2()
			{
				world.Step(1 / 60, 10, 10);
				/*if(attached == 1)
				    wheel.ApplyForce(new b2Vec2(0 * wheel.GetMass(), -10 * wheel.GetMass()), wheel.GetPosition());*/
				world.DrawDebugData();
				world.ClearForces();
				movetile();
				if (levattach == 1)
					attach2();
				//conveyor_motion();
				/*portals();
				if(portalsystem.redportal.exist==1||portalsystem.blueportal.exist==1)
				portalsystem.draw();
				if(portalsystem.redportal.exist==1&&portalsystem.blueportal.exist==1)
				portalsystem.draw();*/
				if (scope == 1)
					ray();
				/*if(wheel.GetPosition() == win)
				{
				    cancelAnimationFrame(frame);
				}*/
				var frame2 = window.requestAnimationFrame(update2);
			};
	    }
		window.onload = function ()
		{
			/*portalsystem.redportal.x = 10*30*xlimit/1200;
			portalsystem.redportal.y = 10*30*ylimit/900;
			portalsystem.blueportal.x = 20 * 30*xlimit/1200;
			portalsystem.blueportal.y = 20 * 30*ylimit/900;*/
			portalsystem.redportal.exist = 0;
			portalsystem.blueportal.exist = 0;
			portalsystem.redportal.color = 'Crimson';
			portalsystem.blueportal.color = 'rgba(54, 161, 255, 0.8)';
			level1();
		}
	</script>

</html>
