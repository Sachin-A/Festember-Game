<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Portal</title>
    <script type="text/javascript" src="Box2D.js"></script>
	<script type="text/javascript" src="Box2dWeb-2.1.a.3.js"></script>
    <script type="text/javascript" src="jquery-1.7.1.min.js"></script>
    <style>
        html,
        body {
            font-size: 18px;
            width: 100%;
            height: 100%;
            margin: 0px;
            border: 0;
            overflow: hidden;
            display: block;
        }
        
        #cc {
            top: 400px;
            width: 600px;
            height: 100px;
            margin: 0;
            overflow: auto;
        }
    </style>
</head>

<body onresize="resize_canvas()" onkeydown="downkeyhandler(event)" onkeyup="upkeyhandler(event)" onmousemove="getPos(event)" onmouseout="stopTracking()" onmousedown="mousedown(event)">
    <!-- An fps counter 
    <div id="fps"></div>-->
    <!--<div id="displayArea"></div>-->
    <canvas id="canvas" style="background-color:rgba(0, 0, 0, 0.5)"></canvas>
</body>
<script>
    //canvas variables
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    //GLOBAL: canvas resize function & variables
    function resize_canvas()
    {
        canvas = document.getElementById("canvas");
        if (canvas.width < window.innerWidth)
        {
            canvas.width = window.innerWidth;
        }
        if (canvas.height < window.innerHeight)
        {
            canvas.height = window.innerHeight;
        }
    }
    var ylimit = canvas.height;
    var xlimit = canvas.width;
    var xylimit = ylimit * xlimit;
    var scale = 30;

    //function initialisations
    var b2Vec2 = Box2D.Common.Math.b2Vec2,
        b2BodyDef = Box2D.Dynamics.b2BodyDef,
        b2Body = Box2D.Dynamics.b2Body,
        b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
        b2World = Box2D.Dynamics.b2World,
        b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
        b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
        b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef,
        b2MouseJointDef = Box2D.Dynamics.Joints.b2MouseJointDef,
        b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
        b2Fixture = Box2D.Dynamics.b2Fixture,
        b2RayCastInput = Box2D.Collision.b2RayCastInput,
        b2RayCastOutput = Box2D.Collision.b2RayCastOutput,
        b2AABB = Box2D.Collision.b2AABB;

    //world variable
    var world = new b2World(new b2Vec2(0, 10), true);

    //ray variables
    var rayLength = xlimit; //long enough to hit the walls
    var currentRayAngle = 0;
    var input = new b2RayCastInput();
    var output = new b2RayCastOutput();
    var b = new b2BodyDef();
    var f = new b2FixtureDef();
    var closestFraction = 1;
    var intersectionPoint = new b2Vec2();
    var p2 = new b2Vec2();
    var normalEnd = new b2Vec2();
    var scope = 0;
    var DEGTORAD = Math.PI / 180;
    var count = 0;
    var circle = 0;
    var x;
    var y;
	
	var tempbody = new b2BodyDef();
	tempbody.type = b2Body.b2_staticBody;
    tempbody.position.Set(0,0);
    tempbody.userData = 'null';
	var tempfix = new b2FixtureDef();
	tempfix.density = 10;
    tempfix.friction = 0.5;
    tempfix.restitution = 0.6;
    tempfix.shape = new b2CircleShape(0.001 * (xlimit + ylimit) / (1200 + 900));
	var temp = world.CreateBody(tempbody);
    temp.CreateFixture(tempfix);
	
	var tempbody = new b2BodyDef();
	tempbody.type = b2Body.b2_staticBody;
    tempbody.position.Set(0,0);
    tempbody.userData = 'null';
	var tempfix = new b2FixtureDef();
	tempfix.density = 10;
    tempfix.friction = 0.5;
    tempfix.restitution = 0.6;
    tempfix.shape = new b2CircleShape(0.001 * (xlimit + ylimit) / (1200 + 900));
	var temp2 = world.CreateBody(tempbody);
    temp2.CreateFixture(tempfix);

    //portal variable
    var pcreate = 0;
	var current=0;
	var shouldmove=0;
	var newpo=new b2Vec2();
	var vel=new b2Vec2();
	var ang;
	var magx;
	var magy;
	var mag;
	var relang;
	
	//bounce variable
	var shouldbounce=0;
	var vspeed=new b2Vec2();
	
	
    //conveyor and attach variables
    /*var attached = 0;
    var toattach = 0;
    var levattach = 0;
    var levattached = 0;
    var move1 = new b2Vec2(7 * xlimit / 1200, 0);
    var move2 = new b2Vec2(0, -8 * ylimit / 900);
    var move3 = new b2Vec2(-10 * xlimit / 1200, 0);*/
    var zero = new b2Vec2(0, 0);
	var gah;

    //Player: Circle
    //body definition
    var bodyDef = new b2BodyDef;
    bodyDef.type = b2Body.b2_dynamicBody;
    bodyDef.position.Set(4 * xlimit / 1200, 25 * ylimit / 900);
    bodyDef.userData = 'obj';

    //fixture definition
    var fixDef = new b2FixtureDef;
    fixDef.density = 10;
    fixDef.friction = 1;
    fixDef.restitution = 0.6;
    fixDef.shape = new b2CircleShape(1 * (xlimit + ylimit) / (1200 + 900));

    //wheel creation
    var wheel = world.CreateBody(bodyDef);
    wheel.CreateFixture(fixDef);

    //Assigning wheel's position as the beginning point of ray casting
    var p1 = wheel.GetPosition(); //centre of scene

    //anti-gravity variable
    var attract = new b2Vec2(0, -10 * wheel.GetMass());

    //force variable
    var f1 = new b2Vec2(6 * wheel.GetMass(), 0);
    var f2 = new b2Vec2(0, -12 * wheel.GetMass());
    var f3 = new b2Vec2(-12 * wheel.GetMass(), 0);

    //fps display
    var fps = {
        startTime: 0,
        frameNumber: 0,
        getFPS: function()
        {
            this.frameNumber++;
            var d = new Date().getTime(),
                currentTime = (d - this.startTime) / 1000,
                result = Math.floor((this.frameNumber / currentTime));

            if (currentTime > 1)
            {
                this.startTime = new Date().getTime();
                this.frameNumber = 0;
            }
            return result;
        }
    };
    var fpsa = document.getElementById('fps');

    //GLOBAL: portals function to exchange position
    function portals(tempbody,tempbody2)
    {
		if(current==0)
		{
		relang=tempbody2.GetAngle()-tempbody.GetAngle()+Math.PI;
		magx=wheel.GetLinearVelocity().x;
		magy=wheel.GetLinearVelocity().y;
		vel.x=-(magx*Math.cos(relang)+magy*Math.sin(relang));
		vel.y=-magx*Math.sin(relang)+magy*Math.cos(relang);
		newpo.x=tempbody.GetPosition().x;
		newpo.y=tempbody.GetPosition().y;
		shouldmove=1;
		current=1;
		}
    }

	var redportal = 
	{
        draw: function()
        {
            ctx.fillStyle = this.color;
			ctx.fillRect(temp.GetPosition().x*scale*xlimit/1200,temp.GetPosition().y*scale*ylimit/900, 2*scale*xlimit/1200,0.3*scale*ylimit/900 );
			
        }
    };
	
    var blueportal = 
	{
        draw: function()
        {
            ctx.fillStyle = blueportal.color;
			ctx.fillRect(temp2.GetPosition().x*scale*xlimit/1200,temp2.GetPosition().y*scale*ylimit/900, 2*scale*xlimit/1200,0.3*scale*ylimit/900 );
        }
    };
	
	function mousedown(event) 
	{
		switch (event.which) 
		{
			case 1:if(scope==1)
					{		
					if(pcreate==0)pcreate=1;
				    else if(pcreate==1||pcreate==10)pcreate=2;
				    else if(pcreate==2||pcreate==20)pcreate=1;
					}
					break;
			case 2:break;
			case 3:break;
			default:break;
		}
	}

    function getPos(e)
    {
        x = e.clientX;
        y = e.clientY;
    }

    function stopTracking()
    {

    }

	var pull = [];
	var listener = new Box2D.Dynamics.b2ContactListener;
    listener.BeginContact = function(contact) // will be fired when contact begins
        {
            fxA = contact.GetFixtureA(); // 1st FIXTURE which COLLIDES
            fxB = contact.GetFixtureB(); // 2nd FIXTURE which COLLIDES
			fbA = fxA.GetBody();
			fbB = fxB.GetBody();
			AUD=fbA.GetUserData();
			BUD=fbB.GetUserData();
            sA = fxA.IsSensor(); // Will store whether 1st fixture is a sensor or not (true or false)
            sB = fxB.IsSensor(); // Will store whether 2nd fixture is a sensor or not (true or false)
            if ((sA && !sB) || (sB && !sA)) // Will go on further iff Fixture A or B not both are sensors.
            {
                if (sA) // If Fixture A is a Sensor
                {
					CUD=temp2.GetUserData();
					DUD=temp.GetUserData();
					if(AUD=='portal' && CUD=='portal' && BUD=='obj' && fbA==temp && (pcreate==2||pcreate==20))
					{
					//alert("here1");
					fxB.SetRestitution(1);
                    portals(temp2,temp);
					}
					else if(AUD=='portal' && DUD=='portal' && BUD=='obj' && fbA==temp2 && (pcreate==2||pcreate==20))
					{
					fxB.SetRestitution(1);
					//alert("here2");
                    portals(temp,temp2);
					}
					if(AUD=='bounce' && BUD=='obj')
					{
					shouldbounce=1;
					vspeed.x=wheel.GetLinearVelocity().x*2;
					vspeed.y=wheel.GetLinearVelocity().y*2;
					}
					if(AUD=='conveyor' && BUD=='obj')
					{
					pull.push(fbA);
					}
                }
                else // If Fixture B is a Sensor
                {
					CUD=temp2.GetUserData();
					DUD=temp.GetUserData();
                    if(BUD=='portal' && CUD=='portal' && AUD=='obj' && fbB==temp && (pcreate==2||pcreate==20))
					{
					fxA.SetRestitution(1);
					//alert("here3");
					portals(temp2,temp);
					}
					else if(BUD=='portal' && DUD=='portal' && AUD=='obj' && fbB==temp2 && (pcreate==2||pcreate==20))
					{
					fxA.SetRestitution(1);
					//alert("here4");
					portals(temp,temp2);
					}
					if(BUD=='bounce' && AUD=='obj')
					{
					shouldbounce=1;
					vx=wheel.GetLinearVelocity().x*2;
					vy=wheel.GetLinearVelocity().y*2;
					}
					if(BUD=='conveyor' && AUD=='obj')
					{
					pull.push(fbB);
					}
                }
            }
        }
	listener.EndContact = function(contact) 
	{
         	 fxA=contact.GetFixtureA();
			 fxB=contact.GetFixtureB();
			 fbA = fxA.GetBody();
			 fbB = fxB.GetBody();
			 AUD=fbA.GetUserData();
			 BUD=fbB.GetUserData();
			 sA=fxA.IsSensor();
			 sB=fxB.IsSensor();
			 if((sA && !sB) || (sB && !sA))	{
				 if(sA)	
				 {
					CUD=temp2.GetUserData();
					DUD=temp.GetUserData();
					if(AUD=='portal' && CUD=='portal' && BUD=='obj' && fbA==temp && (pcreate==2||pcreate==20))
					{
						fxB.SetRestitution(0.6);
						//alert("Here0001");
						current=0;
					}
					else if(AUD=='portal' && DUD=='portal' && BUD=='obj' && fbA==temp2 && (pcreate==2||pcreate==20))
					{
						fxB.SetRestitution(0.6);
						//alert("Here0002");
						current=0;
					}
					if(AUD=='conveyor' && BUD=='obj')
					{
					var index = pull.indexOf(fbA); 
					pull.splice(index,1);
					}
					
				 }
				 else	
				 {
					CUD=temp2.GetUserData();
					DUD=temp.GetUserData();
					if(BUD=='portal' && CUD=='portal' && AUD=='obj' && fbB==temp && (pcreate==2||pcreate==20))
					{
						fxA.SetRestitution(0.6);
						//alert("Here0003");
						current=0;
					}
					else if(BUD=='portal' && DUD=='portal' && AUD=='obj' && fbB==temp2 && (pcreate==2||pcreate==20))
					{
						fxA.SetRestitution(0.6);
						//alert("Here0004");
						current=0;
					}
					if(BUD=='conveyor' && AUD=='obj')
					{
					var index = pull.indexOf(fbB); 
					pull.splice(index,1);
					}
				 }
			 }
		 }
	
    function ray()
    {
        var k = 360 / 5;
        var t = k / 60;
        p2.x = x / scale;
        p2.y = y / scale;
        input.p1 = p1;
        input.p2 = p2;
        input.maxFraction = 1;
        closestFraction = 1;
		var intersectionNormal = new b2Vec2(0, 0);
        var b = new b2BodyDef();
        var f = new b2FixtureDef();
        for (b = world.GetBodyList(); b; b = b.GetNext())
        {
            for (f = b.GetFixtureList(); f; f = f.GetNext())
            {
				gah = b.GetUserData();
                if (!f.RayCast(output, input))
                    continue;
                else if (output.fraction < closestFraction && gah!='conveyor')
                {
                    closestFraction = output.fraction;
                    intersectionNormal = output.normal;
					if(pcreate==1 && gah=='portal' && temp2!=b)
					{
						temp=b;
						pcreate=10;
					}
					if(pcreate==1 && gah!='portal')
					{
						pcreate=0;
					}
					if(pcreate==2 && gah=='portal' && temp!=b)
					{
						temp2=b;
						pcreate=20;
					}
					if(pcreate==2 && gah!='portal')
					{
						pcreate=1;
					}
                }
            }
        }
        intersectionPoint.x = p1.x + closestFraction * (p2.x - p1.x);
        intersectionPoint.y = p1.y + closestFraction * (p2.y - p1.y);
        normalEnd.x = intersectionPoint.x + intersectionNormal.x;
        normalEnd.y = intersectionPoint.y + intersectionNormal.y;
        ctx.strokeStyle = "rgba(255, 255, 255, 10)";
        ctx.lineWidth = 5;
        ctx.bordercolor = 'red';
        ctx.borderwidth = 10;
        ctx.beginPath();
        ctx.moveTo(p1.x * scale, p1.y * scale);
        ctx.lineTo(intersectionPoint.x * scale, intersectionPoint.y * scale);
        ctx.closePath();
        ctx.stroke();
        ctx.lineWidth = 1;
    }

    function downkeyhandler(event)
    {
        var keycode = event.which;
        switch (keycode)
        {
            case 32:if (count == 0) count = 1;
					else if (count == 1) count = 0;
					break;
            case 37:
                var mass = wheel.GetMass() * 10;
                wheel.ApplyImpulse(new b2Vec2(-0.1*mass, 0), wheel.GetPosition());
                break;
            case 38:
                var mass = wheel.GetMass() * 10;
                wheel.ApplyImpulse(new b2Vec2(0, -0.5*mass), wheel.GetPosition());
                break;
            case 39:
                var mass = wheel.GetMass() * 10;
                wheel.ApplyImpulse(new b2Vec2(0.1*mass, 0), wheel.GetPosition());
                break;
            case 40:
                var mass = wheel.GetMass() * 10;
                wheel.ApplyImpulse(new b2Vec2(0, 0.1*mass), wheel.GetPosition());
                break;
            case 79:
                circle = 1;
                break;
            case 80:
                if (scope == 0)
                    scope = 1;
                else if (scope == 1)
                    scope = 0;
                break;
            case 66:
                if (portalsystem.blueportal.exist == 0 && scope == 1)
                {
                    portalsystem.blueportal.exist = 1;
                    portalsystem.draw();
                }
                break;
            case 82:
                if (portalsystem.redportal.exist == 0 && scope == 1)
                {
                    portalsystem.redportal.exist = 1;
                    portalsystem.draw();
                }
                break;
            case 88:
                DEGTORAD = -Math.PI / 180;
                break;
            case 90:
                DEGTORAD = Math.PI / 180;
                break;
            default:
                break;
        }
    }

    function upkeyhandler(event)
    {
        var keycode = event.which;
        switch (keycode)
        {
            case 79:circle = 0;
					break;
            default:break;
        }
    }

    var debugDraw = new b2DebugDraw();
    debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
    debugDraw.SetDrawScale(30); //define scale
    debugDraw.SetFillAlpha(0.1); //define transparency
    debugDraw.SetLineThickness(0.1);
    debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
    //debugDraw.SetFlags(b2DebugDraw.e_shapeBit);
    world.SetDebugDraw(debugDraw);
    var winx = 7 * scale * xlimit / 1200;
    var winy = ylimit - (19 * scale * ylimit / 900);

    function level1()
    {
		
        for (b = world.GetBodyList(); b; b = b.GetNext())
        {
            if (b != wheel)
                world.DestroyBody(b);
        }
		var start2=new b2Vec2(4*xlimit/1200,25*ylimit/900);
		wheel.SetPosition(start2);
		console.log("Inside level1");
		
		var mag1=0;
		var mag2=0;
		var mag3=0;
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(-1 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border1 = world.CreateBody(bodyDef);
        border1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) - (31 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1* ylimit / 900);
        var border2 = world.CreateBody(bodyDef);
        border2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(41 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border3 = world.CreateBody(bodyDef);
        border3.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) + (9 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1 * ylimit / 900);
        var border4 = world.CreateBody(bodyDef);
        border4.CreateFixture(fd);
		
        // Ground 1
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
        var ground1 = world.CreateBody(bodyDef);
        ground1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (2.1 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p1 = world.CreateBody(bodyDef);
        p1.CreateFixture(fd1);

        // Ground 2
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (9 * xlimit / 1200), (ylimit / scale) - (1 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
        var ground2 = world.CreateBody(bodyDef);
        ground2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (9 * xlimit / 1200), (ylimit / scale) - (2.1 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p2 = world.CreateBody(bodyDef);
        p2.CreateFixture(fd1);

        // First floor
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(17 * xlimit / 1200, (ylimit / scale) - (11 * ylimit / 900));
		bodyDef.userData='carrier';
        var floor = new b2FixtureDef;
        floor.shape = new b2PolygonShape();
        floor.shape.SetAsOrientedBox(17 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var firstfloor = world.CreateBody(bodyDef);
        firstfloor.CreateFixture(floor);

        //c1b1
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(3 * xlimit / 1200, (ylimit / scale) - (9 * ylimit / 900));
		bodyDef.userData='cbox';
        var box1 = new b2FixtureDef;
        box1.shape = new b2PolygonShape();
        box1.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
		var c1b1 = world.CreateBody(bodyDef);
        c1b1.CreateFixture(box1);
			
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.Set(3 * xlimit / 1200, (ylimit / scale) - (9 * ylimit / 900));
		bodyDef.userData='conveyor';
		var fixDef2 = new b2FixtureDef;
        fixDef2.shape = new b2CircleShape(5);
        fixDef2.shape.SetLocalPosition(new b2Vec2(0, 0));
        fixDef2.density = 0;
        fixDef2.isSensor = true;
        var CC1 = world.CreateBody(bodyDef);
        CC1.CreateFixture(fixDef2);
        
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(3 * xlimit / 1200, (ylimit / scale) - (7.9 * ylimit / 900));
		bodyDef.userData='portal';
		var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(1.5 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p3= world.CreateBody(bodyDef);
		p3.CreateFixture(fd1);
		

        //c1b2
        /*var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(15 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
		bodyDef.userData='cbox';
        var box2 = new b2FixtureDef;
        box2.shape = new b2PolygonShape();
        box2.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var c1b2 = world.CreateBody(bodyDef);
        c1b2.CreateFixture(box2);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.Set(15 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
		bodyDef.userData='conveyor';
		var fixDef2 = new b2FixtureDef;
        fixDef2.shape = new b2CircleShape(5);
        fixDef2.shape.SetLocalPosition(new b2Vec2(0, 0));
        fixDef2.density = 0;
        fixDef2.isSensor = true;
        var CC2 = world.CreateBody(bodyDef);
        CC2.CreateFixture(fixDef2);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(15 * xlimit / 1200, (ylimit / scale) - (8.9 * ylimit / 900));
		bodyDef.userData='portal';
		var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(1.5 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p4= world.CreateBody(bodyDef);
		p4.CreateFixture(fd1);
		

        //c1b3
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(27 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
		bodyDef.userData='cbox';
        var box3 = new b2FixtureDef;
        box3.shape = new b2PolygonShape();
        box3.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var c1b3 = world.CreateBody(bodyDef);
        c1b3.CreateFixture(box3);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.Set(27 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
		bodyDef.userData='conveyor';
		var fixDef2 = new b2FixtureDef;
        fixDef2.shape = new b2CircleShape(5);
        fixDef2.shape.SetLocalPosition(new b2Vec2(0, 0));
        fixDef2.density = 0;
        fixDef2.isSensor = true;
        var CC3 = world.CreateBody(bodyDef);
        CC3.CreateFixture(fixDef2);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(27 * xlimit / 1200, (ylimit / scale) - (8.9 * ylimit / 900));
		bodyDef.userData='portal';
		var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(1.5 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p5= world.CreateBody(bodyDef);
		p5.CreateFixture(fd1);*/

        //lift
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (0.5 * xlimit / 1200), (ylimit / scale) - (12 * ylimit / 900));
		bodyDef.userData='carrier';
        var f = new b2FixtureDef;
        f.shape = new b2PolygonShape();
        f.shape.SetAsOrientedBox(0.5 * xlimit / 1200, 12 * ylimit / 900, new b2Vec2(0, 0), 0);
        var lift = world.CreateBody(bodyDef);
        lift.CreateFixture(f);
		
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (2 * ylimit / 900));
		bodyDef.userData='cbox';
        var b1 = new b2FixtureDef;
        b1.shape = new b2PolygonShape();
        b1.shape.SetAsOrientedBox(2 * ylimit / 900, 0.5 * xlimit / 1200, new b2Vec2(0, 0), (Math.PI/2));
        var c2b1 = world.CreateBody(bodyDef);
        c2b1.CreateFixture(b1);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (2 * ylimit / 900));
		bodyDef.userData='conveyor';
		var fixDef2 = new b2FixtureDef;
        fixDef2.shape = new b2CircleShape(5);
        fixDef2.shape.SetLocalPosition(new b2Vec2(0, 0));
        fixDef2.density = 0;
        fixDef2.isSensor = true;
        var CC2 = world.CreateBody(bodyDef);
        CC2.CreateFixture(fixDef2);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (2.1 * xlimit / 1200), (ylimit / scale) - (2 * ylimit / 900));
		bodyDef.userData='portal';
		var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(1 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), (Math.PI)/2);
        fd1.isSensor = true;
		var p4= world.CreateBody(bodyDef);
		p4.CreateFixture(fd1);
		
        /*var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (10 * ylimit / 900));
		bodyDef.userData='cbox';
        var b2 = new b2FixtureDef;
        b2.shape = new b2PolygonShape();
        b2.shape.SetAsOrientedBox(2 * ylimit / 900, 0.5 * xlimit / 1200, new b2Vec2(0, 0), Math.PI/2);
        var c2b2 = world.CreateBody(bodyDef);
        c2b2.CreateFixture(b2);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (10 * ylimit / 900));
		bodyDef.userData='conveyor';
		var fixDef2 = new b2FixtureDef;
        fixDef2.shape = new b2CircleShape(3);
        fixDef2.shape.SetLocalPosition(new b2Vec2(0, 0));
        fixDef2.density = 0;
        fixDef2.isSensor = true;
        var CC5 = world.CreateBody(bodyDef);
        CC5.CreateFixture(fixDef2);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (2.1 * xlimit / 1200), (ylimit / scale) - (10 * ylimit / 900));
		bodyDef.userData='portal';
		var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(1 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), (Math.PI)/2);
        fd1.isSensor = true;
		var p7= world.CreateBody(bodyDef);
		p7.CreateFixture(fd1);
		
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (18 * ylimit / 900));
		bodyDef.userData='cbox';
        var b3 = new b2FixtureDef;
        b3.shape = new b2PolygonShape();
        b3.shape.SetAsOrientedBox(2 * ylimit / 900,0.5 * xlimit / 1200, new b2Vec2(0, 0), Math.PI/2);
        var c2b3 = world.CreateBody(bodyDef);
        c2b3.CreateFixture(b3);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.Set((xlimit / scale) - (1.5 * xlimit / 1200), (ylimit / scale) - (18 * ylimit / 900));
		bodyDef.userData='conveyor';
		var fixDef2 = new b2FixtureDef;
        fixDef2.shape = new b2CircleShape(3);
        fixDef2.shape.SetLocalPosition(new b2Vec2(0, 0));
        fixDef2.density = 0;
        fixDef2.isSensor = true;
        var CC6 = world.CreateBody(bodyDef);
        CC6.CreateFixture(fixDef2);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set((xlimit / scale) - (2.1 * xlimit / 1200), (ylimit / scale) - (18 * ylimit / 900));
		bodyDef.userData='portal';
		var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(1 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), (Math.PI)/2);
        fd1.isSensor = true;
		var p8= world.CreateBody(bodyDef);
		p8.CreateFixture(fd1);*/

        // intermediate floor
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(18 * xlimit / 1200, (ylimit / scale) - (16 * ylimit / 900));
		bodyDef.userData='ground';
        var floor = new b2FixtureDef;
        floor.shape = new b2PolygonShape();
        floor.shape.SetAsOrientedBox(18 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var Ifloor = world.CreateBody(bodyDef);
        Ifloor.CreateFixture(floor);

        // Second floor
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(22 * xlimit / 1200, (ylimit / scale) - (29 * ylimit / 900));
		bodyDef.userData='carrier';
        var floor2 = new b2FixtureDef;
        floor2.shape = new b2PolygonShape();
        floor2.shape.SetAsOrientedBox(18 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var floor2 = world.CreateBody(bodyDef);
        floor2.CreateFixture(floor);
        
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(7 * xlimit / 1200, (ylimit / scale) - (27 * ylimit / 900));
		bodyDef.userData='cbox';
        var bx1 = new b2FixtureDef;
        bx1.shape = new b2PolygonShape();
        bx1.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var c3b1 = world.CreateBody(bodyDef);
        c3b1.CreateFixture(bx1);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.Set(7 * xlimit / 1200, (ylimit / scale) - (27 * ylimit / 900));
		bodyDef.userData='conveyor';
		var fixDef2 = new b2FixtureDef;
        fixDef2.shape = new b2CircleShape(6);
        fixDef2.shape.SetLocalPosition(new b2Vec2(0, 0));
        fixDef2.density = 0;
        fixDef2.isSensor = true;
        var CC3 = world.CreateBody(bodyDef);
        CC3.CreateFixture(fixDef2);
        
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(7 * xlimit / 1200, (ylimit / scale) - (25.9 * ylimit / 900));
		bodyDef.userData='portal';
		var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(1.5 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p5= world.CreateBody(bodyDef);
		p5.CreateFixture(fd1);
		
		
        
		/*var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(25 * xlimit / 1200, (ylimit / scale) - (27 * ylimit / 900));
		bodyDef.userData='cbox';
        var bx2 = new b2FixtureDef;
        bx2.shape = new b2PolygonShape();
        bx2.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var c3b2 = world.CreateBody(bodyDef);
        c3b2.CreateFixture(bx2);
        
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(37 * xlimit / 1200, (ylimit / scale) - (27 * ylimit / 900));
		bodyDef.userData='cbox';
        var bx3 = new b2FixtureDef;
        bx3.shape = new b2PolygonShape();
        bx3.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var c3b3 = world.CreateBody(bodyDef);
        c3b3.CreateFixture(bx3);*/
		
		function conveyor_motion()
        {
            var b = new b2BodyDef();
            for (b = world.GetBodyList(); b; b = b.GetNext())
            {
                if (b == c1b1 || b == p3 || b == CC1)
                {
                    if (b.GetPosition().x >= 31 * xlimit / 1200)
                        mag1=-0.1;
					if(b.GetPosition().x <= 3 * xlimit / 1200)
						mag1=0.1;
                    var movex = b.GetPosition().x + (mag1 * xlimit / 1200);
                    var movey = b.GetPosition().y;
                    var move = new b2Vec2(movex, movey);
                    b.SetPosition(move);
                }
				if (b == c2b1 || b == p4 || b == CC2)
                {
                    if (b.GetPosition().y >= 27 * ylimit / 900)
                        mag2=-0.2;
					if (b.GetPosition().y <= 8 * ylimit / 900)
						mag2=0.2;
                    var movey = b.GetPosition().y + (mag2 * ylimit / 900);
                    var movex = b.GetPosition().x;
                    var move = new b2Vec2(movex, movey);
                    b.SetPosition(move);
                }
				if (b == c3b1 || b == p5 || b == CC3)
                {
                    if (b.GetPosition().x >= 37 * xlimit / 1200)
                        mag3=-0.1;
					if(b.GetPosition().x <= 7 * xlimit / 1200)
						mag3=0.1;
                    var movex = b.GetPosition().x + (mag3 * xlimit / 1200);
                    var movey = b.GetPosition().y;
                    var move = new b2Vec2(movex, movey);
                    b.SetPosition(move);
                }
            }
        }

        /*function conveyor_motion()
        {
            var b = new b2BodyDef();
            for (b = world.GetBodyList(); b; b = b.GetNext())
            {
                if (b == c1b1 || b == c1b2 || b == c1b3||b==p3||b==p4||b==p5 ||b==CC1 ||b==CC2 || b==CC3)
                {
                    //console.log(b.GetPosition());
                    var back1 = new b2Vec2(-3 * xlimit / 1200, b.GetPosition().y);
                    if (b.GetPosition().x >= 33 * xlimit / 1200)
                        b.SetPosition(back1);
                    var movex = b.GetPosition().x + (0.1 * xlimit / 1200);
                    var movey = b.GetPosition().y;
                    var move = new b2Vec2(movex, movey);
                    b.SetPosition(move);
                    //wheel.SetLinearVelocity(move);
                }
                if (b == c2b1 || b == c2b2 || b == c2b3 || b == p6 || b == p7 || b == p8 ||b==CC4 ||b==CC5 || b==CC6)
                {
                    //console.log(b.GetPosition());
                    var back2 = new b2Vec2(b.GetPosition().x, 32 * ylimit / 900);
                    if (b.GetPosition().y <= 8 * ylimit / 900)
                        b.SetPosition(back2);
                    var movex = b.GetPosition().x;
                    var movey = b.GetPosition().y - (0.2 * ylimit / 900);
                    var move = new b2Vec2(movex, movey);
                    b.SetPosition(move);
                    //wheel.SetLinearVelocity(move);
                }
                if (b == c3b1 || b == c3b2 || b == c3b3)
                {
                    //console.log(b.GetPosition());
                    var back3 = new b2Vec2(43 * xlimit / 1200, b.GetPosition().y);
                    if (b.GetPosition().x <= 7 * xlimit / 1200)
                        b.SetPosition(back3);
                    var movex = b.GetPosition().x - (0.2 * xlimit / 1200);
                    var movey = b.GetPosition().y;
                    var move = new b2Vec2(movex, movey);
                    b.SetPosition(move);
                    //wheel.SetLinearVelocity(move);
                }
            }
        }*/

        function attach()
        {
			for (i = 0; i < pull.length; i++)
            {
                var c1 = wheel.GetWorldCenter();
                var c2 = pull[i].GetWorldCenter();
                var vecnew = new b2Vec2();
                vecnew.x = c2.x - c1.x;
                vecnew.y = c2.y - c1.y;
                var magnew = Math.sqrt(((vecnew.x * vecnew.x) + (vecnew.y * vecnew.y)));
                vecnew.x = vecnew.x / magnew;
                vecnew.y = vecnew.y / magnew;
                var force = new b2Vec2();
                force.x = 1500 * vecnew.x;
                force.y = 2500 * vecnew.y;
                wheel.ApplyForce(force, wheel.GetWorldCenter());
                wheel.SetAngularDamping(10);
            }
        }

        update1();

        function update1()
        {
            /*if (toattach == 1)
            {
                attach();
            }*/
            world.Step(1 / 60, 10, 10);
			/*for (b = world.GetBodyList() ; b; b = b.GetNext())
			{
				var angle = b.GetAngle()*(180/Math.PI);
				for(f = b.GetFixtureList(); f; f = f.GetNext()) {
		 
				 if (b.GetUserData() == 'obj')
				 {
					 var radius = f.GetShape().GetRadius();
					 var pos = b.GetPosition();
		 
					 ctx.save();
		 
					 ctx.translate( pos.x * 30, pos.y * 30 );
					 ctx.rotate( angle * (Math.PI/180) );
					 ctx.translate( -pos.x * 30, -pos.y * 30 );
		 
					 ctx.beginPath();
					 ctx.arc(pos.x * 30, pos.y * 30, radius * 30, 0, 2 * Math.PI, false);
					 ctx.closePath();
					 ctx.lineWidth = 5;
					 ctx.strokeStyle = "rgb(255, 255, 0)";
					 ctx.fillStyle = "rgb(255, 255, 255)";
					 ctx.stroke();
					 ctx.fill();
		 
					 ctx.restore();
		 
				  }
				  
				  else if (b.GetUserData() == 'ground')
				   {    
					  var vertices;
					  var ver = new Array;
					  var temp = new Array;
					  vertices = f.GetShape().GetVertices();
					  for(x in vertices)    {
						temp[x] = b.GetWorldPoint(vertices[x]); 
					  }
		 
					  ver = temp;
		 
					  ctx.save();
		 
					  ctx.beginPath();
					  ctx.moveTo(ver[0].x * 30, ver[0].y * 30);
					  for(var s in ver) {
						  if(s!=0)
							ctx.lineTo(ver[s].x * 30, ver[s].y * 30);                     
					  }
		 
					  ctx.closePath();
		 
					  ctx.fillStyle = "#FF0000";
					  ctx.strokeStyle = "#030340";
					  ctx.lineWidth = 1;
					  ctx.stroke();
					  ctx.fill();                     
		 
					  ctx.restore();          
				   }      
		 
				  else if (b.GetUserData() == 'ground')
				  { 
					  var X = f.GetShape().GetVertices()[1].x - f.GetShape().GetVertices()[0].x; 
					  var Y = f.GetShape().GetVertices()[2].y - f.GetShape().GetVertices()[1].y;    
					  var pos = b.GetPosition();
		 
					  ctx.save();
		 
					  ctx.translate( pos.x * 30, pos.y * 30 );
					  ctx.rotate( angle * (Math.PI/180) );
					  ctx.translate( -pos.x * 30, -pos.y * 30 );
		 
					  ctx.lineWidth = 3;
					  ctx.strokeStyle = "rgb(33, 212, 125)";
					  ctx.strokeRect(((pos.x * 30) - (X * 30 / 2)), ((pos.y * 30) - (Y * 30 / 2)), X * 30, Y * 30);
					  ctx.fillStyle = "rgb(255, 40, 100)";
					  ctx.fillRect(((pos.x * 30) - (X * 30 / 2)), ((pos.y * 30) - (Y * 30 / 2)), X * 30, Y * 30);
		 
					  ctx.restore();
		 
				   }
				   else if (b.GetUserData() == 'carrier')
				   {    
					  var vertices;
					  var ver = new Array;
					  var temp = new Array;
					  vertices = f.GetShape().GetVertices();
					  for(x in vertices)    {
						temp[x] = b.GetWorldPoint(vertices[x]); 
					  }
		 
					  ver = temp;
		 
					  ctx.save();
		 
					  ctx.beginPath();
					  ctx.moveTo(ver[0].x * 30, ver[0].y * 30);
					  for(var s in ver) {
						  if(s!=0)
							ctx.lineTo(ver[s].x * 30, ver[s].y * 30);                     
					  }
		 
					  ctx.closePath();
		 
					  ctx.fillStyle = "#FF0000";
					  ctx.strokeStyle = "#030340";
					  ctx.lineWidth = 1;
					  ctx.stroke();
					  ctx.fill();                     
		 
					  ctx.restore();          
				   }      
					else if (b.GetUserData() == 'carrier')
					{ 
					  var X = f.GetShape().GetVertices()[1].x - f.GetShape().GetVertices()[0].x; 
					  var Y = f.GetShape().GetVertices()[2].y - f.GetShape().GetVertices()[1].y;    
					  var pos = b.GetPosition();
		 
					  ctx.save();
		 
					  ctx.translate( pos.x * 30, pos.y * 30 );
					  ctx.rotate( angle * (Math.PI/180) );
					  ctx.translate( -pos.x * 30, -pos.y * 30 );
		 
					  ctx.lineWidth = 3;
					  ctx.strokeStyle = "rgb(255, 40, 100)";
					  ctx.strokeRect(((pos.x * 30) - (X * 30 / 2)), ((pos.y * 30) - (Y * 30 / 2)), X * 30, Y * 30);
					  ctx.fillStyle = "rgb(255, 40, 100)";
					  ctx.fillRect(((pos.x * 30) - (X * 30 / 2)), ((pos.y * 30) - (Y * 30 / 2)), X * 30, Y * 30);
		 
					  ctx.restore();
		 
					}
					else if (b.GetUserData() == 'cbox')
				   {    
					  var vertices;
					  var ver = new Array;
					  var temp = new Array;
					  vertices = f.GetShape().GetVertices();
					  for(x in vertices)    {
						temp[x] = b.GetWorldPoint(vertices[x]); 
					  }
		 
					  ver = temp;
		 
					  ctx.save();
		 
					  ctx.beginPath();
					  ctx.moveTo(ver[0].x * 30, ver[0].y * 30);
					  for(var s in ver) {
						  if(s!=0)
							ctx.lineTo(ver[s].x * 30, ver[s].y * 30);                     
					  }
		 
					  ctx.closePath();
		 
					  ctx.fillStyle = "#FF0000";
					  ctx.strokeStyle = "#030340";
					  ctx.lineWidth = 1;
					  ctx.stroke();
					  ctx.fill();                     
		 
					  ctx.restore();          
				   }      
					else if (b.GetUserData() == 'cbox')
					{ 
					  var X = f.GetShape().GetVertices()[1].x - f.GetShape().GetVertices()[0].x; 
					  var Y = f.GetShape().GetVertices()[2].y - f.GetShape().GetVertices()[1].y;    
					  var pos = b.GetPosition();
		 
					  ctx.save();
		 
					  ctx.translate( pos.x * 30, pos.y * 30 );
					  ctx.rotate( angle * (Math.PI/180) );
					  ctx.translate( -pos.x * 30, -pos.y * 30 );
		 
					  ctx.lineWidth = 3;
					  ctx.strokeStyle = "rgb(25, 40, 100)";
					  ctx.strokeRect(((pos.x * 30) - (X * 30 / 2)), ((pos.y * 30) - (Y * 30 / 2)), X * 30, Y * 30);
					  ctx.fillStyle = "rgb(25, 40, 100)";
					  ctx.fillRect(((pos.x * 30) - (X * 30 / 2)), ((pos.y * 30) - (Y * 30 / 2)), X * 30, Y * 30);
		 
					  ctx.restore();
		 
					}
					else if (b.GetUserData() == 'conveyor')
				   {    
					  var vertices;
					  var ver = new Array;
					  var temp = new Array;
					  vertices = f.GetShape().GetVertices();
					  for(x in vertices)    {
						temp[x] = b.GetWorldPoint(vertices[x]); 
					  }
		 
					  ver = temp;
		 
					  ctx.save();
		 
					  ctx.beginPath();
					  ctx.moveTo(ver[0].x * 30, ver[0].y * 30);
					  for(var s in ver) {
						  if(s!=0)
							ctx.lineTo(ver[s].x * 30, ver[s].y * 30);                     
					  }
		 
					  ctx.closePath();
		 
					  ctx.fillStyle = "#FF0000";
					  ctx.strokeStyle = "#030340";
					  ctx.lineWidth = 1;
					  ctx.stroke();
					  ctx.fill();                     
		 
					  ctx.restore();          
				   }      
					else if (b.GetUserData() == 'conveyor')
					{ 
					  var X = f.GetShape().GetVertices()[1].x - f.GetShape().GetVertices()[0].x; 
					  var Y = f.GetShape().GetVertices()[2].y - f.GetShape().GetVertices()[1].y;    
					  var pos = b.GetPosition();
		 
					  ctx.save();
		 
					  ctx.translate( pos.x * 30, pos.y * 30 );
					  ctx.rotate( angle * (Math.PI/180) );
					  ctx.translate( -pos.x * 30, -pos.y * 30 );
		 
					  ctx.lineWidth = 3;
					  ctx.strokeStyle = "rgb(33, 212, 125)";
					  ctx.strokeRect(((pos.x * 30) - (X * 30 / 2)), ((pos.y * 30) - (Y * 30 / 2)), X * 30, Y * 30);
					  ctx.fillStyle = "rgb(255, 40, 100)";
					  ctx.fillRect(((pos.x * 30) - (X * 30 / 2)), ((pos.y * 30) - (Y * 30 / 2)), X * 30, Y * 30);
		 
					  ctx.restore();
		 
					}
				                      
				}
			}*/
            world.DrawDebugData();
            world.ClearForces();
            world.SetContactListener(listener);
            //fpsa.innerHTML = fps.getFPS();
            conveyor_motion();
			if(count==1)
			{
				attach();
			}
			if(shouldmove==1)
			{
				wheel.SetPosition(newpo);
				wheel.SetLinearVelocity(vel);
				shouldmove=0;
			}
			if(pcreate>0)
			{
			redportal.draw();
			blueportal.draw();
			}
            if (circle == 1)
            {
                ctx.fillStyle = "rgba(255,255,255,0.1)";
                ctx.beginPath();
                ctx.arc(wheel.GetPosition().x * scale, wheel.GetPosition().y * scale, 4 * scale, 0, Math.PI * 2, false);
                ctx.closePath();
                ctx.fill();
            }
            //portals();
            /*if (portalsystem.redportal.exist == 1 || portalsystem.blueportal.exist == 1)
                portalsystem.draw();
            if (portalsystem.redportal.exist == 1 && portalsystem.blueportal.exist == 1)
                portalsystem.draw();*/
            if (scope == 1)
            {
                ray();
            }
            ctx.fillStyle = 'rgba(145,145,255,0.5)';
            ctx.beginPath();
            ctx.arc(winx, winy, 15 * (xlimit + ylimit) / (1200 + 900), 0, Math.PI * 2, false);
            ctx.closePath();
            ctx.fill();
            if (Math.sqrt(Math.pow(wheel.GetPosition().x * scale - winx, 2) + Math.pow(wheel.GetPosition().y * scale - winy, 2)) > 50)
            {
                var frame = window.requestAnimationFrame(update1);
            }
            else
            {
				wheel.SetLinearVelocity(zero);
				wheel.SetAngularVelocity(0);
				pcreate=0;
                console.log("Done");
                level2();
            }
        }
    }
	
	function level2()
    {
        for (b = world.GetBodyList(); b; b = b.GetNext())
        {
            if (b != wheel)
                world.DestroyBody(b);
        }
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(-1 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border1 = world.CreateBody(bodyDef);
        border1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) - (31 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1* ylimit / 900);
        var border2 = world.CreateBody(bodyDef);
        border2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(41 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border3 = world.CreateBody(bodyDef);
        border3.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) + (9 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1 * ylimit / 900);
        var border4 = world.CreateBody(bodyDef);
        border4.CreateFixture(fd);
		
		var winx2 =19 * scale * xlimit / 1200;
		var winy2 = ylimit - (17 * scale * ylimit / 900);
		
		var start2=new b2Vec2(5*xlimit/1200,10*ylimit/900);
		wheel.SetPosition(start2);
        
		console.log("Second level");
        
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
        var ground1 = world.CreateBody(bodyDef);
        ground1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (2.1 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p12 = world.CreateBody(bodyDef);
        p12.CreateFixture(fd1);
		
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(35 * xlimit / 1200, (ylimit / scale) - (25 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(5 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var roof = world.CreateBody(bodyDef);
        roof.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(35 * xlimit / 1200, (ylimit / scale) - (23.9 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p13 = world.CreateBody(bodyDef);
        p13.CreateFixture(fd1);
		
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(35 * xlimit / 1200, (ylimit / scale) - (5 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 3.5*Math.PI/4);
        var tilt = world.CreateBody(bodyDef);
        tilt.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(35 * xlimit / 1200, (ylimit / scale) - (5 * ylimit / 900));
		bodyDef.userData='bounce';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 1.2 * ylimit / 900, new b2Vec2(0, 0), 3.5*Math.PI/4);
        fd1.isSensor = true;
		var bounce1 = world.CreateBody(bodyDef);
        bounce1.CreateFixture(fd1);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(19 * xlimit / 1200, (ylimit / scale) - (21 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var platform2 = world.CreateBody(bodyDef);
        platform2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(19 * xlimit / 1200, (ylimit / scale) - (21 * ylimit / 900));
		bodyDef.userData='bounce';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 1.2 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var bounce2 = world.CreateBody(bodyDef);
        bounce2.CreateFixture(fd1);
		
		
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(19 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var platform = world.CreateBody(bodyDef);
        platform.CreateFixture(fd);
		
        update2();

        function update2()
        {
            world.Step(1 / 60, 10, 10);
			world.SetContactListener(listener);
            world.DrawDebugData();
            world.ClearForces();
			if(shouldmove==1)
			{
				wheel.SetPosition(newpo);
				wheel.SetLinearVelocity(vel);
				shouldmove=0;
			}
			if(shouldbounce==1)
			{
				wheel.SetLinearVelocity(vspeed);
				shouldbounce=0;
			}
			if(pcreate>0)
			{
			redportal.draw();
			blueportal.draw();
			}
			if (circle == 1)
            {
                ctx.fillStyle = "rgba(255,255,255,0.1)";
                ctx.beginPath();
                ctx.arc(wheel.GetPosition().x * scale, wheel.GetPosition().y * scale, 4 * scale, 0, Math.PI * 2, false);
                ctx.closePath();
                ctx.fill();
            }
			ctx.fillStyle = 'rgba(145,145,255,0.5)';
            ctx.beginPath();
            ctx.arc(winx2, winy2, 30 * (xlimit + ylimit) / (1200 + 900), 0, Math.PI * 2, false);
            ctx.closePath();
            ctx.fill();
            if (scope == 1)
                ray();
			if (Math.sqrt(Math.pow(wheel.GetPosition().x * scale - winx2, 2) + Math.pow(wheel.GetPosition().y * scale - winy2, 2)) > 50)
            {
                var frame2 = window.requestAnimationFrame(update2);
            }
            else
            {
				wheel.SetLinearVelocity(zero);
				wheel.SetAngularVelocity(0);
				pcreate=0;
                console.log("Done");
                level3();
            }
            //var frame2 = window.requestAnimationFrame(update2);
        };
    }
	
	function level3()
    {
        for (b = world.GetBodyList(); b; b = b.GetNext())
        {
            if (b != wheel)
                world.DestroyBody(b);
        }
		
		var winx3 =30 * scale * xlimit / 1200;
		var winy3 = ylimit - (4 * scale * ylimit / 900);
		
		var start3=new b2Vec2(10*xlimit/1200,25*ylimit/900);
		wheel.SetPosition(start3);
        console.log("Second level");
		
		var mag=0;
        
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(-1 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border1 = world.CreateBody(bodyDef);
        border1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) - (31 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1* ylimit / 900);
        var border2 = world.CreateBody(bodyDef);
        border2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(41 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border3 = world.CreateBody(bodyDef);
        border3.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) + (9 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1 * ylimit / 900);
        var border4 = world.CreateBody(bodyDef);
        border4.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(10 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
        var groundbasic = world.CreateBody(bodyDef);
        groundbasic.CreateFixture(fd);
		
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(30 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(5 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var groundbasic2 = world.CreateBody(bodyDef);
        groundbasic2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) - (12 * ylimit / 900));
		bodyDef.userData='carrier';
        var floor = new b2FixtureDef;
        floor.shape = new b2PolygonShape();
        floor.shape.SetAsOrientedBox(15 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var carrierbasic = world.CreateBody(bodyDef);
        carrierbasic.CreateFixture(floor);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set( 8* xlimit / 1200, (ylimit / scale) - (11 * ylimit / 900));
		bodyDef.userData='cbox';
        var fixDef = new b2FixtureDef;
        fixDef.shape = new b2PolygonShape();
        fixDef.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
		var cbbb = world.CreateBody(bodyDef);
        cbbb.CreateFixture(fixDef);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
		bodyDef.position.Set(8 * xlimit / 1200, (ylimit / scale) - (11 * ylimit / 900));
		bodyDef.userData='conveyor';
		var fixDef2 = new b2FixtureDef;
        fixDef2.shape = new b2CircleShape(5);
        fixDef2.shape.SetLocalPosition(new b2Vec2(0, 0));
        fixDef2.density = 0;
        fixDef2.isSensor = true;
        var CC10 = world.CreateBody(bodyDef);
        CC10.CreateFixture(fixDef2);
		
		function conveyor_motion()
        {
            var b = new b2BodyDef();
            for (b = world.GetBodyList(); b; b = b.GetNext())
            {
                if (b == cbbb || b == CC10)
                {
                    if (b.GetPosition().x >= 32 * xlimit / 1200)
                        mag=-0.1;
					if(b.GetPosition().x <= 8 * xlimit / 1200)
						mag=0.1;
                    var movex = b.GetPosition().x + (mag * xlimit / 1200);
                    var movey = b.GetPosition().y;
                    var move = new b2Vec2(movex, movey);
                    b.SetPosition(move);
                }
            }
        }
		
		function attach()
        {
			for (i = 0; i < pull.length; i++)
            {
                var c1 = wheel.GetWorldCenter();
                var c2 = pull[i].GetWorldCenter();
                var vecnew = new b2Vec2();
                vecnew.x = c2.x - c1.x;
                vecnew.y = c2.y - c1.y;
                var magnew = Math.sqrt(((vecnew.x * vecnew.x) + (vecnew.y * vecnew.y)));
                vecnew.x = vecnew.x / magnew;
                vecnew.y = vecnew.y / magnew;
                var force = new b2Vec2();
                force.x = 1440 * vecnew.x;
                force.y = 1440 * vecnew.y;
                wheel.ApplyForce(force, wheel.GetWorldCenter());
                wheel.SetAngularDamping(3);
            }
        }
		
        update3();

        function update3()
        {
            world.Step(1 / 60, 10, 10);
			world.SetContactListener(listener);
            world.DrawDebugData();
            world.ClearForces();
			conveyor_motion();
			if(count==1)
			{
				attach();
			}
			if (circle == 1)
            {
                ctx.fillStyle = "rgba(255,255,255,0.1)";
                ctx.beginPath();
                ctx.arc(wheel.GetPosition().x * scale, wheel.GetPosition().y * scale, 4 * scale, 0, Math.PI * 2, false);
                ctx.closePath();
                ctx.fill();
            }
			ctx.fillStyle = 'rgba(145,145,255,0.5)';
            ctx.beginPath();
            ctx.arc(winx3, winy3, 30 * (xlimit + ylimit) / (1200 + 900), 0, Math.PI * 2, false);
            ctx.closePath();
            ctx.fill();
            if (scope == 1)
                ray();
			if (Math.sqrt(Math.pow(wheel.GetPosition().x * scale - winx3, 2) + Math.pow(wheel.GetPosition().y * scale - winy3, 2)) > 50)
            {
                var frame3 = window.requestAnimationFrame(update3);
            }
            else
            {
				wheel.SetLinearVelocity(zero);
				wheel.SetAngularVelocity(0);
				pcreate=0;
                console.log("Done");
                level4();
            }
            //var frame2 = window.requestAnimationFrame(update2);
        };
    }
	
	function level4()
    {
        for (b = world.GetBodyList(); b; b = b.GetNext())
        {
            if (b != wheel)
                world.DestroyBody(b);
        }
		
		var winx4 =35 * scale * xlimit / 1200;
		var winy4 = ylimit - (18 * scale * ylimit / 900);
		
		var start4=new b2Vec2(5*xlimit/1200,22*ylimit/900);
		wheel.SetPosition(start4);
        console.log("Second level");
		
		var mag=0;
        
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(-1 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border1 = world.CreateBody(bodyDef);
        border1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) - (31 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1* ylimit / 900);
        var border2 = world.CreateBody(bodyDef);
        border2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(41 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border3 = world.CreateBody(bodyDef);
        border3.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) + (9 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1 * ylimit / 900);
        var border4 = world.CreateBody(bodyDef);
        border4.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
        var ground = world.CreateBody(bodyDef);
        ground.CreateFixture(fd);
		
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(35 * xlimit / 1200, (ylimit / scale) - (29 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(5 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var roof = world.CreateBody(bodyDef);
        roof.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(35 * xlimit / 1200, (ylimit / scale) - (15 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(5 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var roof2 = world.CreateBody(bodyDef);
        roof2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (2.1 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p1 = world.CreateBody(bodyDef);
        p1.CreateFixture(fd1);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(35 * xlimit / 1200, (ylimit / scale) - (27.9 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p2 = world.CreateBody(bodyDef);
        p2.CreateFixture(fd1);
		
        update4();

        function update4()
        {
            world.Step(1 / 60, 10, 10);
			world.SetContactListener(listener);
            world.DrawDebugData();
            world.ClearForces();
			if(shouldmove==1)
			{
				wheel.SetPosition(newpo);
				wheel.SetLinearVelocity(vel);
				shouldmove=0;
			}
			if(pcreate>0)
			{
			redportal.draw();
			blueportal.draw();
			}
			if (circle == 1)
            {
                ctx.fillStyle = "rgba(255,255,255,0.1)";
                ctx.beginPath();
                ctx.arc(wheel.GetPosition().x * scale, wheel.GetPosition().y * scale, 4 * scale, 0, Math.PI * 2, false);
                ctx.closePath();
                ctx.fill();
            }
			ctx.fillStyle = 'rgba(145,145,255,0.5)';
            ctx.beginPath();
            ctx.arc(winx4, winy4, 30 * (xlimit + ylimit) / (1200 + 900), 0, Math.PI * 2, false);
            ctx.closePath();
            ctx.fill();
            if (scope == 1)
                ray();
			if (Math.sqrt(Math.pow(wheel.GetPosition().x * scale - winx4, 2) + Math.pow(wheel.GetPosition().y * scale - winy4, 2)) > 50)
            {
                var frame4 = window.requestAnimationFrame(update4);
            }
            else
            {
				wheel.SetLinearVelocity(zero);
				wheel.SetAngularVelocity(0);
				pcreate=0;
                console.log("Done");
                level5();
            }
            //var frame2 = window.requestAnimationFrame(update2);
        };
    }
	
	function level5()
    {
        for (b = world.GetBodyList(); b; b = b.GetNext())
        {
            if (b != wheel)
                world.DestroyBody(b);
        }
		
		var winx4 =35 * scale * xlimit / 1200;
		var winy4 = ylimit - (18 * scale * ylimit / 900);
		
		var start5=new b2Vec2(5*xlimit/1200,22*ylimit/900);
		wheel.SetPosition(start5);
        console.log("Second level");
		
		var mag=0;
        
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(-1 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border1 = world.CreateBody(bodyDef);
        border1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) - (31 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1* ylimit / 900);
        var border2 = world.CreateBody(bodyDef);
        border2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(41 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(1 * xlimit / 1200, 20 * ylimit / 900);
        var border3 = world.CreateBody(bodyDef);
        border3.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(20 * xlimit / 1200, (ylimit / scale) + (9 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(20 * xlimit / 1200, 1 * ylimit / 900);
        var border4 = world.CreateBody(bodyDef);
        border4.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
        var ground = world.CreateBody(bodyDef);
        ground.CreateFixture(fd);
		
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (22 * ylimit / 900));
		bodyDef.userData='ground';
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(5 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), Math.PI);
        var roof = world.CreateBody(bodyDef);
        roof.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (2.1 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p1 = world.CreateBody(bodyDef);
        p1.CreateFixture(fd1);
		p1.SetAngle(0);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (20.9 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p2 = world.CreateBody(bodyDef);
        p2.CreateFixture(fd1);
		p2.SetAngle(Math.PI);
		
        update5();

        function update5()
        {
            world.Step(1 / 60, 10, 10);
			world.SetContactListener(listener);
            world.DrawDebugData();
            world.ClearForces();
			if(shouldmove==1)
			{
				wheel.SetPosition(newpo);
				wheel.SetLinearVelocity(vel);
				shouldmove=0;
			}
			if(pcreate>0)
			{
			redportal.draw();
			blueportal.draw();
			}
			if (circle == 1)
            {
                ctx.fillStyle = "rgba(255,255,255,0.1)";
                ctx.beginPath();
                ctx.arc(wheel.GetPosition().x * scale, wheel.GetPosition().y * scale, 4 * scale, 0, Math.PI * 2, false);
                ctx.closePath();
                ctx.fill();
            }
			ctx.fillStyle = 'rgba(145,145,255,0.5)';
            ctx.beginPath();
            ctx.arc(winx4, winy4, 30 * (xlimit + ylimit) / (1200 + 900), 0, Math.PI * 2, false);
            ctx.closePath();
            ctx.fill();
            if (scope == 1)
                ray();
			if (Math.sqrt(Math.pow(wheel.GetPosition().x * scale - winx4, 2) + Math.pow(wheel.GetPosition().y * scale - winy4, 2)) > 50)
            {
                var frame5 = window.requestAnimationFrame(update5);
            }
            else
            {
				wheel.SetLinearVelocity(zero);
				wheel.SetAngularVelocity(0);
				pcreate=0;
                console.log("Done");
                level1();
            }
            //var frame2 = window.requestAnimationFrame(update2);
        };
    }
	
    /*function level2()
    {
        for (b = world.GetBodyList(); b; b = b.GetNext())
        {
            if (b != wheel)
                world.DestroyBody(b);
        }
        console.log("Second level");
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (1 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsBox(5 * xlimit / 1200, 1 * ylimit / 900);
        var ground1 = world.CreateBody(bodyDef);
        ground1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(5 * xlimit / 1200, (ylimit / scale) - (2.1 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(3 * xlimit / 1200, 0.1 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p12 = world.CreateBody(bodyDef);
        p12.CreateFixture(fd1);
		
        // Tile 1
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(25 * xlimit / 1200, (ylimit / scale) - (15 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var tile1 = world.CreateBody(bodyDef);
        tile1.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(25 * xlimit / 1200, (ylimit / scale) - (15 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(2.5 * xlimit / 1200, 1.2 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p13 = world.CreateBody(bodyDef);
        p13.CreateFixture(fd1);
		
		var revoluteJointDef1 = new b2RevoluteJointDef();
		revoluteJointDef1.Initialize(tile1, p13, tile1.GetWorldCenter());
		revoluteJointDef1.maxMotorTorque = 1100.0;
		revoluteJointDef1.motorSpeed = 3.0;
		revoluteJointDef1.enableMotor = true;
		revoluteJointA = world.CreateJoint(revoluteJointDef1);
		
        // Tile 2
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(13 * xlimit / 1200, (ylimit / scale) - (5 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var tile2 = world.CreateBody(bodyDef);
        tile2.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(13 * xlimit / 1200, (ylimit / scale) - (5 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(2.5 * xlimit / 1200, 1.2 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p14 = world.CreateBody(bodyDef);
        p14.CreateFixture(fd1);
		
        // Tile 3
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(19 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var tile3 = world.CreateBody(bodyDef);
        tile3.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(19 * xlimit / 1200, (ylimit / scale) - (10 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(2.5 * xlimit / 1200, 1.2 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p15 = world.CreateBody(bodyDef);
        p15.CreateFixture(fd1);
		
        // Tile 4
        var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(31 * xlimit / 1200, (ylimit / scale) - (20 * ylimit / 900));
        var fd = new b2FixtureDef;
        fd.shape = new b2PolygonShape;
        fd.shape.SetAsOrientedBox(3 * xlimit / 1200, 1 * ylimit / 900, new b2Vec2(0, 0), 0);
        var tile4 = world.CreateBody(bodyDef);
        tile4.CreateFixture(fd);
		
		var bodyDef = new b2BodyDef;
        bodyDef.type = b2Body.b2_staticBody;
        bodyDef.position.Set(31 * xlimit / 1200, (ylimit / scale) - (20 * ylimit / 900));
		bodyDef.userData='portal';
        var fd1 = new b2FixtureDef;
        fd1.shape = new b2PolygonShape;
        fd1.shape.SetAsOrientedBox(2.5 * xlimit / 1200, 1.2 * ylimit / 900, new b2Vec2(0, 0), 0);
        fd1.isSensor = true;
		var p16 = world.CreateBody(bodyDef);
        p16.CreateFixture(fd1);
		
		xincrease = 1;
		

        function movetile()
        {
            xincrease = xincrease + 1;
            for (b = world.GetBodyList(); b; b = b.GetNext())
                if (b== tile1 || b == tile2 || b == tile3 || b == tile4 || b==p13 || b==p14 || b==p15 || b==p16)
                    {
						b.SetAngle(xincrease * (Math.PI / 180));
					}
        }
        var debugDraw = new b2DebugDraw();
        debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
        debugDraw.SetDrawScale(30); //define scale
        debugDraw.SetFillAlpha(1); //define transparency
        debugDraw.SetLineThickness(1);
        debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
        //debugDraw.SetFlags(b2DebugDraw.e_shapeBit);
        world.SetDebugDraw(debugDraw);

        function attach2()
        {
            for (b = world.GetBodyList(); b; b = b.GetNext())
                if (b == tile1 || b == tile2 || b == tile3 || b == tile4)
                {
                    if (Math.sqrt(Math.pow(wheel.GetPosition().x - b.GetPosition().x, 2) + Math.pow(wheel.GetPosition().y - b.GetPosition().y, 2)) <= 7 * xlimit / 1200 && levattached == 0)
                    {
                        var set = new b2Vec2(b.GetPosition().x, b.GetPosition().y - 2);
                        //console.log("Attached in A=" + attached);
                        wheel.SetPosition(set);
                        levattached = 1;
                    }
                }
        }
        update2();

        function update2()
        {
            world.Step(1 / 60, 10, 10);
			world.SetContactListener(listener);
            world.DrawDebugData();
            world.ClearForces();
            movetile();
			if(shouldmove==1)
			{
				wheel.SetPosition(newpo);
				wheel.SetLinearVelocity(vel);
				shouldmove=0;
			}
            if (levattach == 1)
                attach2();
			if(pcreate>0)
			{
			redportal.draw();
			blueportal.draw();
			}
			if (circle == 1)
            {
                ctx.fillStyle = "rgba(255,255,255,0.1)";
                ctx.beginPath();
                ctx.arc(wheel.GetPosition().x * scale, wheel.GetPosition().y * scale, 4 * scale, 0, Math.PI * 2, false);
                ctx.closePath();
                ctx.fill();
            }
            if (scope == 1)
                ray();
            var frame2 = window.requestAnimationFrame(update2);
        };
    }*/
    window.onload = function()
    {
		redportal.x=0;
		redportal.y=0;
		blueportal.x=100;
		blueportal.y=100;
		redportal.color='rgba(215, 44, 44, 0.6)';
		blueportal.color='rgba(54, 161, 255, 0.6)';
        level1();
    }
</script>

</html>
